<!DOCTYPE html>
<html>
<head>
	<title>Contract</title>
	 <script type="text/javascript" src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
   	<link href="background.css" rel="stylesheet" type="text/css">
   	    <script>
      function getContract() {
        return localStorage.getItem("contractAddress");
      }
      function getAddress() {
        return localStorage.getItem("sellerAddress");
      }
		</script>
		<style>
		body {
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 0;
		}

		h2 {
			text-align: center;
			font-size: 36px;
			font-weight: bold;
			margin-top: 40px;
			margin-bottom: 20px;
		}

		h2:after {
			content: "";
			display: block;
			border-bottom: 4px solid #333;
			margin-top: 10px;
			margin-bottom: 20px;
		}
/*
		.container {
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			justify-content: center;
			align-items: stretch;
			align-content: stretch;
			width: 100%;
			height: 100%;
		}

		.half {
			display: flex;
			flex-direction: column;
			flex-basis: 50%;
			flex-grow: 1;
			flex-shrink: 1;
			align-items: center;
			justify-content: center;
			padding: 20px;
		}*/

				.container {
/*			display: flex;
			flex-wrap: wrap;*/
						display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			justify-content: center;
			align-items: stretch;
			align-content: stretch;
			width: 100%;
			height: 100%;
		}
		.half {
/*			width: 50%;
			padding: 10px;
			box-sizing: border-box;*/
			display: flex;
			flex-direction: column;
			flex-basis: 50%;
			flex-grow: 1;
			flex-shrink: 1;
			align-items: center;
			justify-content: center;
			padding: 20px;
		}
		.half:nth-child(1) {
			display: flex;
			flex-direction: row;
		}
		.half:nth-child(1) .section {
			width: 50%;
			padding: 10px;
			box-sizing: border-box;
			border: 1px solid black;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}
		.half:nth-child(1) .section:nth-child(1) {
			border-right: none;
		}

		table {
			border-collapse: collapse;
			width: 100%;
		}

		th, td {
			padding: 8px;
			text-align: left;
			border-bottom: 1px solid #ddd;
		}

		th {
			background-color: #f2f2f2;
		}
	</style>
</head>
<body>
	<div class="container">
			<h1 id="Contract">Contract: </h1>
			<h1 id="Address">Address: </h1>
<!-- 			<h1 id="Balance">Balance: </h1> -->
		<div class="half">
			<div class="section">
			<h2>Product</h2>
			<div class="product-image">
				<img id="productImage" src="" alt="Product Image">
			</div>
			<div class="product-details">
				<h3 id="productName"></h3>
				<p id="productPrice"></p>
				<p id="productDescription"></p>
				<p id="productDetails"></p>
	
			</div>
			</div>
			<div class="section">
				<h2>Contract functions</h2>
				<p>Functions related to the contract go here...</p>
		<button onclick="getBalance()">GET BALANCE OF THE CONTRACT</button>
        <p id="balanceArea">Balance: Not Connected to Contract</p>
         <button onclick="confirmShipped()">CONFIRM SHIPPED</button> <br>
        <input type="text" id="addressInputCS" placeholder="Enter Address"> <br>
        <p id="dataArea6"></p>
        <button onclick="refundSeller()">CLAIM PROFIT + ESCROW FROM BUYER</button> <br>
        <input type="text" id="addressInputRS" placeholder="Enter Address"> <br>
        <p id="dataArea8"></p>
        <button onclick="addEscrow()">ADD ESCROW</button> <br>
        <p id="dataArea13"></p>
        <button onclick="closeContract()">TERMINATE CONTRACT</button> <br>
        <p id="dataArea14"></p>

			</div>
		</div>
		<div class="half">
			<h2 id="address">Current buyers</h2>
			<table>
				<thead>
					<tr>
						<th>Name</th>
						<th>Address</th>
						<th>Phone</th>
						<th>Email</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>John Smith</td>
						<td>123 Main St.</td>
						<td>(555) 555-1212</td>
						<td>john@example.com</td>
					</tr>
					<tr>
						<td>Jane Doe</td>
						<td>456 Oak Ave.</td>
						<td>(555) 555-2323</td>
						<td>jane@example.com</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	<script type="text/javascript">
		Parse.initialize("rgzBD2oDrFGwnP4GhepGqvLTb4zxUCVA8ISU94G6", "rbN8I2nlk462haH28HHxwAka3o02oVqWWz1PrFdi"); //PASTE HERE YOUR Back4App APPLICATION ID AND YOUR JavaScript KEY
        Parse.serverURL = "https://parseapi.back4app.com/";


        let value;

        var account = localStorage.getItem("sellerAddress");
        var contract = localStorage.getItem("contractAddress");

        console.log(account);
        console.log(contract);

        document.getElementById('Contract').textContent = "Contract: " + contract;
        document.getElementById('Address').textContent = "Connected As: " + account;
        

        
        //2- connect to smart contract

            const ABI = [{"inputs":[],"stateMutability":"payable","type":"constructor"},{"inputs":[],"name":"InvalidState","type":"error"},{"inputs":[],"name":"OnlyBuyer","type":"error"},{"inputs":[],"name":"OnlySeller","type":"error"},{"inputs":[],"name":"ValueNotEven","type":"error"},{"inputs":[],"name":"notEnoughEscrow","type":"error"},{"anonymous":false,"inputs":[],"name":"Aborted","type":"event"},{"anonymous":false,"inputs":[],"name":"ConfirmShipped","type":"event"},{"anonymous":false,"inputs":[],"name":"ItemReceived","type":"event"},{"anonymous":false,"inputs":[],"name":"PurchaseConfirmed","type":"event"},{"anonymous":false,"inputs":[],"name":"SellerRefunded","type":"event"},{"anonymous":false,"inputs":[],"name":"addedEscrow","type":"event"},{"anonymous":false,"inputs":[],"name":"closedContract","type":"event"},{"inputs":[],"name":"addEscrow","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"buyerNumber","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"checkNoActiveBuyers","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"closeContract","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"confirmPurchase","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"confirmReceived","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"address_","type":"address"}],"name":"confirmShipped","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"createBuyer","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"deposit","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"key","type":"address"}],"name":"doesExist","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"escrowLeft","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBuyerNumber","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"getBuyerState","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getItemDescription","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getItemDetails","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getItemName","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getItemPriceInETH","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getValue","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"item_received_buyer","type":"address"}],"name":"refundSeller","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"seller","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"value","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address payable","name":"_to","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];
            const Address = contract;
            
            window.web3 =  new Web3(window.ethereum);
            window.contract =  new window.web3.eth.Contract(ABI, Address); 

            console.log("connected to smart contract");
            console.log(Address);

            //document.getElementById("Balance").textContent = window.contract.methods.getBalance().call();

            //getBalance();




            		var ProductDetails = Parse.Object.extend("Product_details");
		var query = new Parse.Query(ProductDetails);
		query.equalTo("contractAddress", Address);

		query.first().then(function(product) {
			document.getElementById("productName").textContent = "Listing Name: " + product.get("ProductName");
				document.getElementById("productPrice").textContent = "Price (Wei): " + product.get("ProductPrice");
				document.getElementById("productDescription").textContent = "Product Description: " + product.get("ProductDescription");
				document.getElementById("productDetails").textContent = "Product Details: " + product.get("ProductDetails");

			// document.getElementById("productDetails") = product.get("ProductDetails");
			// var productDetailsList = document.getElementById("productDetails");
			// productDetails.forEach(function(detail) {
			// 	var li = document.createElement("li");
			// 	li.textContent = detail;
			// 	productDetailsList.appendChild(li);
			// });

			var photo = product.get("image").url();

			document.getElementById("productImage").src =  photo;

			// var productImage = document.getElementById("productImage");
			// productImage.src = product.get("image").url();
		}, function(error) {
			console.log(error);
		});



        const getBalance= async () => {
        	// console.log('sddsd');
            const data = await window.contract.methods.getBalance().call();
            document.getElementById("balanceArea").textContent = `Contract Balance (Wei): ${data}`;
            // console.log('fdfddfdfdfdffd');
        }

  
            //document.getElementById("balanceArea").innerHTML = `Contract Balance (Wei): ${data}`;
      

        const confirmShipped = async () => {
            try {
                const address_ = document.getElementById("addressInputCS").value;
                await window.contract.methods.confirmShipped(address_).send({ from: account });
                console.log("Shipping confirmed successfully!");
                document.getElementById("dataArea6").innerHTML = "Shipping confirmed successfully!";
            } catch (error) {
                console.error(error);
                document.getElementById("dataArea6").innerHTML = "Error confirming shipping: " + error;
            }
        };

        const refundSeller = async () => {
            try {
                const address_ = document.getElementById("addressInputRS").value;
                await window.contract.methods.refundSeller(address_).send({ from: account });
                console.log("Seller Refunded successfully!");
                document.getElementById("dataArea8").innerHTML = "Seller Refunded successfully!";
            } catch (error) {
                console.error(error);
                document.getElementById("dataArea8").innerHTML = "Error Refunding Seller: " + error;
            }
        };


        const addEscrow = async () => {

            console.log('hi');


            let result;
            await window.contract.methods.getValue().call()
              .then(function(value) {
                result = value;
              });
            console.log('hi');

            await window.contract.methods.addEscrow().send( {from: account, value: 20 * result} );
            console.log("Escrow added successfully!");
            document.getElementById("dataArea13").innerHTML = "Escrow added successfully!";
        }

        

	</script>
</body>
</html>
