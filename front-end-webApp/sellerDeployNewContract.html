<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
    <link href="background.css" rel="stylesheet" type="text/css">

    <style>
		body {
			background-color: #1e1e1e;
			color: #fff;
			font-family: 'Roboto', sans-serif;
			font-size: 16px;
		}
		h1 {
			font-size: 36px;
			font-weight: bold;
			color: #fff;
			text-align: center;
			margin-top: 50px;
			margin-bottom: 30px;
		}
		#readArea {
			margin: 0 auto;
			max-width: 800px;
			text-align: center;
		}
		button {
			background-color: #007bff;
			border: none;
			border-radius: 5px;
			color: #fff;
			cursor: pointer;
			font-size: 18px;
			font-weight: bold;
			margin-bottom: 20px;
			padding: 10px 30px;
            box-shadow: 0 0.5rem #0069e0;
			transition: background-color 0.3s ease-in-out;
		}
		button:hover {
			transform: translateY(-2px);
            box-shadow: 0 0.8rem #0069e0;
		}

        ::placeholder {
            color: rgb(240, 238, 235);
            text-align: center;
        }

		.cool-input {
			background-color: transparent;
			border: none;
			border-bottom: 2px solid #fff;
			color: #f5f0f0;
			font-size: 18px;
			margin-bottom: 20px;
			padding: 10px;
			width: 50%;
		}
		#cost, #deployValueText {
			font-size: 24px;
			font-weight: bold;
			margin-top: 30px;
		}
		#deployValue {
			background-color: #ecb44f;
			border: none;
			border-radius: 5px;
			color: #fff;
			cursor: pointer;
			font-size: 18px;
			font-weight: bold;
			margin-top: 20px;
			padding: 10px 30px;
			transition: background-color 0.3s ease-in-out;
		}
		#deployValue:hover {
			background-color: #c99134;
		}
		#deployContract, #addItem {
			background-color: #19d852;
			border: none;
			border-radius: 5px;
			color: #fff;
			cursor: pointer;
			font-size: 18px;
			font-weight: bold;
			margin-top: 20px;
			padding: 10px 30px;
			transition: background-color 0.3s ease-in-out;
		}
		#deployContract:hover, #addItem:hover {
			background-color: #149c0f;
		}
		#myProgress {
			background-color: #ddd;
			border-radius: 5px;
			height: 40px;
			margin-top: 20px;
			overflow: hidden;
			width: 100%;
            opacity: 0;
		}
		#myBar {
			background-color: #51e7ec;
			height: 40px;
			line-height: 40px;
			text-align: center;
			transition: width 0.3s ease-in-out;
			width: 0%;
            opacity: 0;
		}
		#contractWaitingArea {
			margin-top: 20px;
		}
		#contractDeployStateArea {
			margin-top: 20px;
		}
		#toContractDetail {
			margin-top: 20px;
		}
	</style>



</head>

<body>
    
    <h1>Deploy New Contract</h1>

    <div id="readArea">
        <br>

        <button onclick="connectMetamask()">CONNECT TO METAMASK</button> <br>
        <p id="accountArea"></p>

        <button onclick="createMyOwnContract()">CREATE MY OWN CONTRACT</button> <br>
        <p id="contractDeployValue"></p>
        <input style="visibility: hidden;" type="text" class="cool-input" id="deployPrice" placeholder="Enter the price of one item in Wei"> <br>
        <br>
        <input style="visibility: hidden;" type="text" class="cool-input" id="deployQuant" placeholder="Enter the total quantity to sell"> <br>
        <br>
        <!-- <input style="visibility: hidden;" type="text" class="cool-input" id="deployValue"> <br> -->
        <button style="visibility: hidden" id = "deployValue" onclick="calculateDeployValue()" >CALCULATE FOR ME </button><br>
        <br>
        <p id="cost"></p>
        <p id="deployValueText"></p>
        <button style="visibility: hidden;" id="deployContract" onclick="deployContract()">DEPLOY CONTRACT</button> 
        <br>

        <p id="contractFollowMetamaskArea"></p>
        <p id="contractStartsDeployingArea"></p>
        <div id="myProgress">
            <div id="myBar">0%</div>
        </div>
        <p id="contractWaitingArea"></p>
        <p id="contractDeployStateArea"></p>
        <p id="contractAddressArea"></p>
        
        <p id="toContractDetail"></p>

        <button style="visibility: hidden;" id="addItem" onclick="location.href = 'sellerAddItemPage.html';">Add Item to My Contract</button>


    </div>

    <script>

        /* Ensure that the page starts at the top whenever refresh the page */
        window.onbeforeunload = function () {
            window.scrollTo(0, 0);
        }

        Parse.initialize("rgzBD2oDrFGwnP4GhepGqvLTb4zxUCVA8ISU94G6", "rbN8I2nlk462haH28HHxwAka3o02oVqWWz1PrFdi"); //PASTE HERE YOUR Back4App APPLICATION ID AND YOUR JavaScript KEY
        Parse.serverURL = "https://parseapi.back4app.com/";

        /* function that helps dynamically output text */

        function outputText(id, text) {

            var index = 0;
            var speed = 30;
            var container = document.getElementById(id);
            
            if (container.innerHTML !== "") {
                container.innerHTML = "";
            }

            var interval = setInterval(function() {
            if (index < text.length) {
                container.innerHTML += text.charAt(index);
                index++;
            } else {
                clearInterval(interval);
            }
            }, speed);
        }


        /* function that helps scroll down the html page*/
        function scrollToPosition(position, duration) {
        // Get the current scroll position
        var start = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        
        // Calculate the distance to scroll
        var distance = position - start;
        
        // Get the start time
        var startTime = null;
        
        function scroll(time) {
          if (startTime === null) {
            startTime = time;
          }
          
          var timeElapsed = time - startTime;
          var progress = Math.min(timeElapsed / duration, 1);
          var scrollTop = start + distance * easeInOutCubic(progress);
          window.scrollTo(0, scrollTop);
          
          if (timeElapsed < duration) {
            window.requestAnimationFrame(scroll);
          }
        }
        
        function easeInOutCubic(t) {
          return t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;
        }
        
        window.requestAnimationFrame(scroll);
        }
      
        function scrollDown() {
            var position = document.body.scrollHeight - window.innerHeight;
            var duration = 1700;
            scrollToPosition(position*0.2, duration);
        }
    


        let account;
        const connectMetamask = async () => {
            if (window.ethereum !== "undefined") {
                const accounts = await ethereum.request({ method: "eth_requestAccounts" });
                account = accounts[0];
                
                var text = `Hello Address: ${account}`;
                
                outputText("accountArea", text);

            }
            
        }

        let quant;
        let price;
        const createMyOwnContract = async () => {


            var text = "Enter the price of one item and the total quantity you want to sell, we will calculate the total amount of escrow you need to depoly";

            outputText("contractDeployValue", text);
            
            scrollDown();

 
            document.getElementById("deployPrice").style.visibility = "visible";
            document.getElementById("deployQuant").style.visibility = "visible";
            


            document.getElementById("deployContract").style.visibility = "visible";
            document.getElementById("deployValue").style.visibility = "visible";


        }

        let cost;
        let deployedValue;
        const calculateDeployValue = async() => {

            quant = document.getElementById("deployQuant").value;
            price = document.getElementById("deployPrice").value;

            cost = quant*price;
            deployedValue = cost * 2;

            var text = `Total cost is ${cost} wei`;
            var text2 = `Total deposit value is ${deployedValue} wei`;

            outputText("cost",text)
            outputText("deployValueText",text2);

        }

        async function pushSellerContract(sellerAddress, contractAddress) {

            const sellerContract = new Parse.Object("sellerContract");

            sellerContract.set("sellerAddress", sellerAddress);
            sellerContract.set("contractAddress", contractAddress);

            try {
                let result = await sellerContract.save();

            } catch (error) {
                alert(`Error: ${error.message}`);

            }
        } 
    

        let contractAddress;
        const deployContract = async () => {

            value = deployedValue;
            console.log(value);

            var text = "Please follow through the Metamask page ";
            
            outputText("contractFollowMetamaskArea", text);
            
            const ABI = [ { "inputs": [], "stateMutability": "payable", "type": "constructor" }, { "inputs": [], "name": "ActiveBuyer", "type": "error" }, { "inputs": [], "name": "ContractTerminated", "type": "error" }, { "inputs": [], "name": "ExceedMaxQuantity", "type": "error" }, { "inputs": [], "name": "InvalidAddress", "type": "error" }, { "inputs": [], "name": "InvalidState", "type": "error" }, { "inputs": [], "name": "ItemAddedAlready", "type": "error" }, { "inputs": [], "name": "ItemNotAdded", "type": "error" }, { "inputs": [], "name": "OnlyBuyer", "type": "error" }, { "inputs": [], "name": "OnlySeller", "type": "error" }, { "inputs": [], "name": "ValueNotEven", "type": "error" }, { "inputs": [], "name": "notEnoughEscrow", "type": "error" }, { "anonymous": false, "inputs": [], "name": "Added_item", "type": "event" }, { "anonymous": false, "inputs": [], "name": "ConfirmShipped", "type": "event" }, { "anonymous": false, "inputs": [], "name": "ItemReceived", "type": "event" }, { "anonymous": false, "inputs": [], "name": "PurchaseConfirmed", "type": "event" }, { "anonymous": false, "inputs": [], "name": "SellerRefunded", "type": "event" }, { "anonymous": false, "inputs": [], "name": "addedEscrow", "type": "event" }, { "anonymous": false, "inputs": [], "name": "closedContract", "type": "event" }, { "inputs": [ { "internalType": "uint256", "name": "quant", "type": "uint256" } ], "name": "addEscrow", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [ { "internalType": "uint256", "name": "inp_value", "type": "uint256" }, { "internalType": "uint256", "name": "inp_quant", "type": "uint256" }, { "internalType": "string", "name": "inp_item_name", "type": "string" }, { "internalType": "string", "name": "inp_item_details", "type": "string" }, { "internalType": "string", "name": "inp_item_descriptions", "type": "string" } ], "name": "add_item", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "checkNoActiveBuyers", "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "closeContract", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [ { "internalType": "uint256", "name": "quant", "type": "uint256" } ], "name": "confirmPurchase", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [], "name": "confirmReceived", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "address_", "type": "address" } ], "name": "confirmShipped", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "key", "type": "address" } ], "name": "doesExist", "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getAddress", "outputs": [ { "internalType": "address", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getBalance", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getBuyerNumber", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "addr", "type": "address" } ], "name": "getBuyerState", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getEscrowLeft", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getItemDescription", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getItemDetails", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getItemName", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getItemPriceInWEI", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getQuantity", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getTotalBuyer", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getValue", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "item_received_buyer", "type": "address" } ], "name": "refundSeller", "outputs": [], "stateMutability": "nonpayable", "type": "function" } ];


            const sellerAddress = account;
            var code = "0x6080604052600060025560006004556000600960006101000a81548160ff0219169083151502179055506000600960016101000a81548160ff02191690831515021790555033600960026101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055503460018190555061274a8061009b6000396000f3fe60806040526004361061012a5760003560e01c8063610be654116100ab578063a0e9ec291161006f578063a0e9ec2914610371578063b905ebaa1461039c578063c819d85a146103d9578063ddfab6a314610404578063f7fb44cd1461042d578063fd52c63f146104585761012a565b8063610be654146102e057806361b53cdc146102ea57806362a759071461031357806373fac6f01461032f5780637c81d123146103465761012a565b80633341dfe6116100f25780633341dfe61461020657806338cc48311461024357806339e878891461026e578063408b9945146102995780634d24e902146102c45761012a565b80630115949c1461012f57806312065fe01461015a57806313b53c57146101855780631a5c0730146101b057806320965255146101db575b600080fd5b34801561013b57600080fd5b50610144610474565b6040516101519190611dac565b60405180910390f35b34801561016657600080fd5b5061016f61047e565b60405161017c9190611dac565b60405180910390f35b34801561019157600080fd5b5061019a610486565b6040516101a79190611dac565b60405180910390f35b3480156101bc57600080fd5b506101c5610490565b6040516101d29190611de2565b60405180910390f35b3480156101e757600080fd5b506101f06104ad565b6040516101fd9190611dac565b60405180910390f35b34801561021257600080fd5b5061022d60048036038101906102289190611e6f565b6104b6565b60405161023a9190611de2565b60405180910390f35b34801561024f57600080fd5b50610258610560565b6040516102659190611eab565b60405180910390f35b34801561027a57600080fd5b50610283610568565b6040516102909190611f56565b60405180910390f35b3480156102a557600080fd5b506102ae6105fa565b6040516102bb9190611dac565b60405180910390f35b6102de60048036038101906102d99190611fa4565b610604565b005b6102e8610952565b005b3480156102f657600080fd5b50610311600480360381019061030c9190611e6f565b610ac9565b005b61032d60048036038101906103289190611e6f565b610dc4565b005b34801561033b57600080fd5b50610344610f96565b005b34801561035257600080fd5b5061035b6111fd565b6040516103689190611f56565b60405180910390f35b34801561037d57600080fd5b5061038661128f565b6040516103939190611f56565b60405180910390f35b3480156103a857600080fd5b506103c360048036038101906103be9190611e6f565b611321565b6040516103d09190611f56565b60405180910390f35b3480156103e557600080fd5b506103ee61150e565b6040516103fb9190611f56565b60405180910390f35b34801561041057600080fd5b5061042b60048036038101906104269190612106565b6115a0565b005b34801561043957600080fd5b50610442611728565b60405161044f9190611dac565b60405180910390f35b610472600480360381019061046d9190611fa4565b611732565b005b6000600354905090565b600047905090565b6000600454905090565b600080600090506000600254036104a657600190505b8091505090565b60008054905090565b60008073ffffffffffffffffffffffffffffffffffffffff16600a60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610556576001905061055b565b600090505b919050565b600030905090565b60606008805461057790612204565b80601f01602080910402602001604051908101604052809291908181526020018280546105a390612204565b80156105f05780601f106105c5576101008083540402835291602001916105f0565b820191906000526020600020905b8154815290600101906020018083116105d357829003601f168201915b5050505050905090565b6000600254905090565b600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff160361068b576040517f86efbb5500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600960019054906101000a900460ff166106d1576040517f4330c19800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600160005460026001546106e59190612293565b6106ef9190612293565b1015610727576040517ffa59aa5c00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b80600354811115610764576040517f3435702900000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600960009054906101000a900460ff16156107ab576040517f6d0d905800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8160005460026107bb91906122c4565b6107c591906122c4565b3414806107d157600080fd5b82600360008282546107e39190612306565b92505081905550600260008154809291906107fd9061233a565b9190505550600460008154809291906108159061233a565b919050555060405180606001604052803373ffffffffffffffffffffffffffffffffffffffff1681526020016000600281111561085557610854612382565b5b815260200184815250600a60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160000160146101000a81548160ff0219169083600281111561090f5761090e612382565b5b0217905550604082015181600101559050507fd5d55c8a68912e9a110618df8d5e2e83b8d83211c57a8ddd1203df92885dc88160405160405180910390a1505050565b600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146109d9576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6109e1610490565b610a17576040517fb3bf834d00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6001600960006101000a81548160ff021916908315150217905550600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f19350505050158015610a9a573d6000803e3d6000fd5b507f76685d578223d8852db93c5274d5fcf6e1146fd0a64794bd61450d94e4a68db760405160405180910390a1565b600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610b50576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b806002806002811115610b6657610b65612382565b5b600a60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160149054906101000a900460ff166002811115610bc857610bc7612382565b5b14610bff576040517fbaf3f0f700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b7ffda69c32bcfdba840a167777906b173b607eb8b4d8853b97a80d26e613d858db60405160405180910390a160026000815480929190610c3e906123b1565b91905055506000600a60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101549050600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc826000546003610cd691906122c4565b610ce091906122c4565b9081150290604051600060405180830381858888f19350505050158015610d0b573d6000803e3d6000fd5b50806002600054610d1c91906122c4565b610d2691906122c4565b600154610d339190612306565b600181905550600a60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556000820160146101000a81549060ff02191690556001820160009055505050505050565b600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610e4b576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b806000806002811115610e6157610e60612382565b5b600a60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160149054906101000a900460ff166002811115610ec357610ec2612382565b5b14610efa576040517fbaf3f0f700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b7fe88a499366edd85624840c77defbb45744582b650f2424cbf1f787d8cde0af9060405160405180910390a16001600a60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160146101000a81548160ff02191690836002811115610f8c57610f8b612382565b5b0217905550505050565b600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff160361101d576040517f86efbb5500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b33600180600281111561103357611032612382565b5b600a60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160149054906101000a900460ff16600281111561109557611094612382565b5b146110cc576040517fbaf3f0f700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b7fe89152acd703c9d8c7d28829d443260b411454d45394e7995815140c8cbcbcf760405160405180910390a16002600a60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160146101000a81548160ff0219169083600281111561115e5761115d612382565b5b02179055503373ffffffffffffffffffffffffffffffffffffffff166108fc600a60003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101546000546111cd91906122c4565b9081150290604051600060405180830381858888f193505050501580156111f8573d6000803e3d6000fd5b505050565b60606007805461120c90612204565b80601f016020809104026020016040519081016040528092919081815260200182805461123890612204565b80156112855780601f1061125a57610100808354040283529160200191611285565b820191906000526020600020905b81548152906001019060200180831161126857829003601f168201915b5050505050905090565b60606005805461129e90612204565b80601f01602080910402602001604051908101604052809291908181526020018280546112ca90612204565b80156113175780601f106112ec57610100808354040283529160200191611317565b820191906000526020600020905b8154815290600101906020018083116112fa57829003601f168201915b5050505050905090565b60608161132d816104b6565b611363576040517fe6c4247b00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6000600a60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160149054906101000a900460ff169050600060028111156113cb576113ca612382565b5b8160028111156113de576113dd612382565b5b03611421576040518060400160405280600481526020017f7061696400000000000000000000000000000000000000000000000000000000815250925050611508565b6001600281111561143557611434612382565b5b81600281111561144857611447612382565b5b0361148b576040518060400160405280600781526020017f7368697070656400000000000000000000000000000000000000000000000000815250925050611508565b60028081111561149e5761149d612382565b5b8160028111156114b1576114b0612382565b5b036114f4576040518060400160405280600881526020017f7265636569766564000000000000000000000000000000000000000000000000815250925050611508565b604051806020016040528060008152509250505b50919050565b60606006805461151d90612204565b80601f016020809104026020016040519081016040528092919081815260200182805461154990612204565b80156115965780601f1061156b57610100808354040283529160200191611596565b820191906000526020600020905b81548152906001019060200180831161157957829003601f168201915b5050505050905090565b600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611627576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600960009054906101000a900460ff161561166e576040517f6d0d905800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600960019054906101000a900460ff16156116b5576040517f6a0dc1aa00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b7f2102e76fd7783eb09271c3b4224bde2fb0a69c21f25f974ad8f5f113fe71433760405160405180910390a16116eb85856118d4565b6116f4836119a4565b6116fd82611a3e565b61170681611ad8565b6001600960016101000a81548160ff0219169083151502179055505050505050565b6000600154905090565b600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146117b9576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600960019054906101000a900460ff166117ff576040517f4330c19800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600960009054906101000a900460ff1615611846576040517f6d0d905800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b80600054600261185691906122c4565b61186091906122c4565b34148061186c57600080fd5b6000829050806003600082825461188391906123da565b92505081905550346001600082825461189c91906123da565b925050819055507f5b0ad5b6591b53a9520a0e0ca3d6293496d11bf227db2b819e7c0e0ab8500a7360405160405180910390a1505050565b600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461195b576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b816000819055508060038190555061197282611b72565b6040516020016119829190612470565b6040516020818303038152906040526005908161199f9190612642565b505050565b600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611a2b576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8060069081611a3a9190612642565b5050565b600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611ac5576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8060079081611ad49190612642565b5050565b600960029054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611b5f576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8060089081611b6e9190612642565b5050565b606060006001611b8184611c40565b01905060008167ffffffffffffffff811115611ba057611b9f611fdb565b5b6040519080825280601f01601f191660200182016040528015611bd25781602001600182028036833780820191505090505b509050600082602001820190505b600115611c35578080600190039150507f3031323334353637383961626364656600000000000000000000000000000000600a86061a8153600a8581611c2957611c28612235565b5b04945060008503611be0575b819350505050919050565b600080600090507a184f03e93ff9f4daa797ed6e38ed64bf6a1f0100000000000000008310611c9e577a184f03e93ff9f4daa797ed6e38ed64bf6a1f0100000000000000008381611c9457611c93612235565b5b0492506040810190505b6d04ee2d6d415b85acef81000000008310611cdb576d04ee2d6d415b85acef81000000008381611cd157611cd0612235565b5b0492506020810190505b662386f26fc100008310611d0a57662386f26fc100008381611d0057611cff612235565b5b0492506010810190505b6305f5e1008310611d33576305f5e1008381611d2957611d28612235565b5b0492506008810190505b6127108310611d58576127108381611d4e57611d4d612235565b5b0492506004810190505b60648310611d7b5760648381611d7157611d70612235565b5b0492506002810190505b600a8310611d8a576001810190505b80915050919050565b6000819050919050565b611da681611d93565b82525050565b6000602082019050611dc16000830184611d9d565b92915050565b60008115159050919050565b611ddc81611dc7565b82525050565b6000602082019050611df76000830184611dd3565b92915050565b6000604051905090565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000611e3c82611e11565b9050919050565b611e4c81611e31565b8114611e5757600080fd5b50565b600081359050611e6981611e43565b92915050565b600060208284031215611e8557611e84611e07565b5b6000611e9384828501611e5a565b91505092915050565b611ea581611e31565b82525050565b6000602082019050611ec06000830184611e9c565b92915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015611f00578082015181840152602081019050611ee5565b60008484015250505050565b6000601f19601f8301169050919050565b6000611f2882611ec6565b611f328185611ed1565b9350611f42818560208601611ee2565b611f4b81611f0c565b840191505092915050565b60006020820190508181036000830152611f708184611f1d565b905092915050565b611f8181611d93565b8114611f8c57600080fd5b50565b600081359050611f9e81611f78565b92915050565b600060208284031215611fba57611fb9611e07565b5b6000611fc884828501611f8f565b91505092915050565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61201382611f0c565b810181811067ffffffffffffffff8211171561203257612031611fdb565b5b80604052505050565b6000612045611dfd565b9050612051828261200a565b919050565b600067ffffffffffffffff82111561207157612070611fdb565b5b61207a82611f0c565b9050602081019050919050565b82818337600083830152505050565b60006120a96120a484612056565b61203b565b9050828152602081018484840111156120c5576120c4611fd6565b5b6120d0848285612087565b509392505050565b600082601f8301126120ed576120ec611fd1565b5b81356120fd848260208601612096565b91505092915050565b600080600080600060a0868803121561212257612121611e07565b5b600061213088828901611f8f565b955050602061214188828901611f8f565b945050604086013567ffffffffffffffff81111561216257612161611e0c565b5b61216e888289016120d8565b935050606086013567ffffffffffffffff81111561218f5761218e611e0c565b5b61219b888289016120d8565b925050608086013567ffffffffffffffff8111156121bc576121bb611e0c565b5b6121c8888289016120d8565b9150509295509295909350565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061221c57607f821691505b60208210810361222f5761222e6121d5565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061229e82611d93565b91506122a983611d93565b9250826122b9576122b8612235565b5b828204905092915050565b60006122cf82611d93565b91506122da83611d93565b92508282026122e881611d93565b915082820484148315176122ff576122fe612264565b5b5092915050565b600061231182611d93565b915061231c83611d93565b925082820390508181111561233457612333612264565b5b92915050565b600061234582611d93565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361237757612376612264565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b60006123bc82611d93565b9150600082036123cf576123ce612264565b5b600182039050919050565b60006123e582611d93565b91506123f083611d93565b925082820190508082111561240857612407612264565b5b92915050565b600081905092915050565b600061242482611ec6565b61242e818561240e565b935061243e818560208601611ee2565b80840191505092915050565b7f2057656900000000000000000000000000000000000000000000000000000000815250565b600061247c8284612419565b91506124878261244a565b60048201915081905092915050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026124f87fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826124bb565b61250286836124bb565b95508019841693508086168417925050509392505050565b6000819050919050565b600061253f61253a61253584611d93565b61251a565b611d93565b9050919050565b6000819050919050565b61255983612524565b61256d61256582612546565b8484546124c8565b825550505050565b600090565b612582612575565b61258d818484612550565b505050565b5b818110156125b1576125a660008261257a565b600181019050612593565b5050565b601f8211156125f6576125c781612496565b6125d0846124ab565b810160208510156125df578190505b6125f36125eb856124ab565b830182612592565b50505b505050565b600082821c905092915050565b6000612619600019846008026125fb565b1980831691505092915050565b60006126328383612608565b9150826002028217905092915050565b61264b82611ec6565b67ffffffffffffffff81111561266457612663611fdb565b5b61266e8254612204565b6126798282856125b5565b600060209050601f8311600181146126ac576000841561269a578287015190505b6126a48582612626565b86555061270c565b601f1984166126ba86612496565b60005b828110156126e2578489015182556001820191506020850194506020810190506126bd565b868310156126ff57848901516126fb601f891682612608565b8355505b6001600288020188555050505b50505050505056fea2646970667358221220f9b0e22f9d6c2f96883f11bbcf27ccfe02d325d1ed1a8c5648fb2e831eac63d164736f6c63430008110033";

            /*const Address = "0x182cc93685355256d9c782dcd8d5e5b43016277c";
            window.web3 = await new Web3(window.ethereum);
            window.contract = await new window.web3.eth.Contract(ABI, Address); */
            

            window.web3 = await new Web3(window.ethereum);
            

            window.web3.eth.sendTransaction({
                from: sellerAddress,
                data: code,
                value: value
            }).on('transactionHash', async function (hash) {
                text = "Contract is now deploying, please wait";
                outputText("contractStartsDeployingArea", text);
                
                await move();

            }).on("receipt", async function (receipt) {
                if (receipt.status == false) {
                    text = "Contract-deploy fails, please check your Metamask page for more details";
                    outputText("contractDeployStateArea", text);
                } else {


                    await move_finish();

                    text = "Contract-deploy successful!";
                    outputText("contractDeployStateArea", text);

                    contractAddress = receipt.contractAddress;

                    text = "Here is your unique contract address: " + contractAddress;
                    outputText("contractAddressArea", text);

                    // store the contract address to the database
                    pushSellerContract(sellerAddress, contractAddress); 
                    
                    // store the contract address and seller address to local storage and ensure the next page can access them
                    localStorage.setItem('contractAddress', contractAddress);
                    localStorage.setItem('sellerAddress', account);
                    localStorage.setItem('itemQuantity', quant);
                    localStorage.setItem('itemPrice', price);

                    console.log(localStorage.getItem("itemPrice"));
                    console.log(localStorage.getItem("itemQuantity"));


                    var button = document.getElementById("addItem");
                    button.style.visibility = "visible";
                    
                }
                
            });
            
            /* funtion of the moving bar */
            async function move() {
                var text = document.getElementById("myProgress");
                var elem = document.getElementById("myBar");
                text.style.opacity = 1.0;
                elem.style.opacity = 1.0;
                
                i = 1;
                var width = 10;
                var id = setInterval(frame, 10);
                function frame() {
                if (width >= 90) {
                    clearInterval(id);
                    i = 0;
                } else {
                    width = width + 0.07;
                    elem.style.width = width + "%";
                    elem.innerHTML = Number((width).toFixed(1))  + "%";
                    }   
                }
                
            }
            
            async function move_finish() {
                var text = document.getElementById("myProgress");
                var elem = document.getElementById("myBar");
                text.style.opacity = 1.0;
                elem.style.opacity = 1.0;
                
                i = 1;
                var width = 90;
                var id = setInterval(frame, 10);
                function frame() {
                if (width >= 100) {
                    clearInterval(id);
                    i = 0;
                } else {
                    width = width + 0.08;
                    if (width > 100) {
                        width = 100;
                        elem.style.width = width + "%";
                        elem.innerHTML = Number((width).toFixed(1))  + "%";
                    } else {
                        elem.style.width = width + "%";
                        elem.innerHTML = Number((width).toFixed(1))  + "%";
                    }
                }
                
            }
            
            async function pushSellerContract(sellerAddress, contractAddress) {

                const sellerContract = new Parse.Object("sellerContract");
   
                sellerContract.set("sellerAddress", sellerAddress);
                sellerContract.set("contractAddress", contractAddress);

                try {
                    let result = await sellerContract.save();

                } catch (error) {
                    alert(`Error: ${error.message}`);

                }
            } 
            
        }
    }

        

    </script>

</body>

</html>