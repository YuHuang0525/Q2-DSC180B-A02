<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <title>CONNECTION TO METAMASK</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
    <link href="background.css" rel="stylesheet" type="text/css">
    <style>
        body {
            background-color: rgb(15, 15, 15);
            font-family: fantasy;
            font-size: 15px;
            display: flex;
            text-align: row;
        }

        button {
            background-color: white;
            font-size: 20px;
            font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif;
        }

        button:hover {
            background-color: yellow;
        }

        h1, h2 {
            text-align: row;
            font-size: 3.0rem;
            font-weight: bold;
            margin-top: 10vh;

            /* Fallback: Set a background color. */
            background-color: white;
            
            /* Create the gradient. */
            background-image: linear-gradient(100deg, #b6f50a, #0ee4e4);
            
            /* Set the background size and repeat properties. */
            background-size: 100%;
            background-repeat: repeat;

            /* Use the text as a mask for the background. */
            /* This will show the gradient as a text color rather than element bg. */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; 
            -moz-background-clip: text;
            -moz-text-fill-color: transparent;
            
        }

        #contractAddress {
            width: 30%;
        }
        
        #setItemName, #setItemPrice{
            width: 25%;
        }

        #setItemDetails {
            width: 25%;
            height: 5%;
        }

        #setItemDescription {
            width: 25%;
            height: 10%;
        }

        #readArea {
            flex-basis: 50%;
        }

        #writeArea {
            flex-basis: 50%;
        }
    </style>
</head>
<body>

    <div id="readArea">
        
        <h1>Seller Page</h1>   

        <br>

        <button onclick="connectMetamask()">CONNECT TO METAMASK</button> <br>
        <p id="accountArea"></p>

        <button onclick="connectContract()">CONNECT TO CONTRACT</button> <br>
        <input type="text" id="contractAddress" placeholder="Enter Your Unique Contract Address"> <br>
        <p id="contractArea"></p>

        <h2>Add new item to your contract</h2>
        <input type="text" id="setItemName" placeholder="Enter Your Item's name"> <br>
        <p id="setItemName1"></p>

        <input type="text" id="setItemPrice" placeholder="Enter Your Item's price in Wei"> <br>
        <p id="setItemPrice1"></p>

        <input type="text" id="setItemDetails" placeholder="Enter Your Item's detail"> <br>
        <p id="setItemDetails1"></p>

        <input type="text" id="setItemDescription" placeholder="Enter a brief description of your item"> <br>
        <p id="setItemDescription1"></p>
        <br>
        <button onclick="addNewItem()">Add New Item</button> <br>
        

    

    </div>

    <div id="writeArea">
        <button onclick="getItemName()">GET ITEM NAME</button> <br>
        <p id="dataArea1"></p>

        <button onclick="getItemPriceInWei()">GET ITEM PRICE (in Wei)</button> <br>
        <p id="dataArea10"></p>
        <button onclick="getItemDetails()">GET ITEM DETAILS</button> <br>
        <p id="dataArea11"></p>
        <button onclick="getItemDescription()">GET ITEM DESCRIPTION</button> <br>
        <p id="dataArea12"></p>


        <button onclick="getBuyerNumber()">GET BUYER NUMBER</button> <br>
	    <p id="dataArea4"></p>
<!--         <button onclick="getCurrentAddress()">GET CURRENT ADDRESS</button> <br>
        <p id="dataArea9"></p> -->



        <button onclick="getContractAccount()">GET CONTRACT ACCOUNT</button>
        <p id="contractAccount">Contract Account: Not Connected to Contract</P>

        <button onclick="getBalance()">GET BALANCE OF THE CONTRACT</button>
        <p id="balanceArea">Balance: Not Connected to Contract</p>


        <button onclick="getBuyerState()">GET BUYER STATE</button> <br>
        <input type="text" id="addressBuyerState" placeholder="Enter Buyer Address"> <br>
        <p id="dataArea3"></p>


        <button onclick="confirmShipped()">CONFIRM SHIPPED (SELLER)</button> <br>
        <input type="text" id="addressInputCS" placeholder="Enter Address"> <br>
        <p id="dataArea6"></p>
        <button onclick="refundSeller()">REFUND SELLER (SELLER)</button> <br>
        <input type="text" id="addressInputRS" placeholder="Enter Address"> <br>
        <p id="dataArea8"></p>
        <button onclick="addEscrow()">ADD ESCROW (SELLER)</button> <br>
        <p id="dataArea13"></p>
        <button onclick="closeContract()">TERMINATE CONTRACT (SELLER)</button> <br>
        <p id="dataArea14"></p>
    </div>
    <script>

        Parse.initialize("rgzBD2oDrFGwnP4GhepGqvLTb4zxUCVA8ISU94G6", "rbN8I2nlk462haH28HHxwAka3o02oVqWWz1PrFdi"); //PASTE HERE YOUR Back4App APPLICATION ID AND YOUR JavaScript KEY
        Parse.serverURL = "https://parseapi.back4app.com/";


        // connect metamask
        let account;
        const connectMetamask = async () => {
            if(window.ethereum !== "undefined") {
                const accounts = await ethereum.request({method: "eth_requestAccounts"});
                account = accounts[0];
                document.getElementById("accountArea").innerHTML = `User Account: ${account}`;
            }
        }

        let value;
        // connect to smart contract
        const connectContract = async () => {
            const ABI = [ { "inputs": [], "stateMutability": "payable", "type": "constructor" }, { "inputs": [], "name": "InvalidState", "type": "error" }, { "inputs": [], "name": "ItemNotAdded", "type": "error" }, { "inputs": [], "name": "OnlyBuyer", "type": "error" }, { "inputs": [], "name": "OnlySeller", "type": "error" }, { "inputs": [], "name": "ValueNotEven", "type": "error" }, { "inputs": [], "name": "notEnoughEscrow", "type": "error" }, { "anonymous": false, "inputs": [], "name": "ConfirmShipped", "type": "event" }, { "anonymous": false, "inputs": [], "name": "ItemReceived", "type": "event" }, { "anonymous": false, "inputs": [], "name": "PurchaseConfirmed", "type": "event" }, { "anonymous": false, "inputs": [], "name": "SellerRefunded", "type": "event" }, { "anonymous": false, "inputs": [], "name": "addedEscrow", "type": "event" }, { "anonymous": false, "inputs": [], "name": "closedContract", "type": "event" }, { "inputs": [], "name": "addEscrow", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [ { "internalType": "uint256", "name": "inp_value", "type": "uint256" }, { "internalType": "string", "name": "inp_item_name", "type": "string" }, { "internalType": "string", "name": "inp_item_details", "type": "string" }, { "internalType": "string", "name": "inp_item_descriptions", "type": "string" } ], "name": "add_item", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "buyerNumber", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "checkNoActiveBuyers", "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "closeContract", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [], "name": "confirmPurchase", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [], "name": "confirmReceived", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "address_", "type": "address" } ], "name": "confirmShipped", "outputs": [], "stateMutability": "payable", "type": "function" }, { "inputs": [], "name": "createBuyer", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "key", "type": "address" } ], "name": "doesExist", "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "escrowLeft", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getAddress", "outputs": [ { "internalType": "address", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getBalance", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getBuyerNumber", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "addr", "type": "address" } ], "name": "getBuyerState", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getItemDescription", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getItemDetails", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getItemName", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getItemPriceInWEI", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getValue", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "quantity", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "item_received_buyer", "type": "address" } ], "name": "refundSeller", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "seller", "outputs": [ { "internalType": "address payable", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "inp_item_descriptions", "type": "string" } ], "name": "setItem_Descriptions", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "inp_item_details", "type": "string" } ], "name": "setItem_Details", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "inp_item_name", "type": "string" } ], "name": "setItem_Name", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "uint256", "name": "inp_value", "type": "uint256" } ], "name": "setValue_Quant", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "value", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" } ]
            
            const address = document.getElementById("contractAddress").value;

            window.web3 = await new Web3(window.ethereum);
            window.contract = await new window.web3.eth.Contract(ABI, address); 

            document.getElementById("contractArea").innerHTML = "connected to smart contract";
        }

        // write to the contract through setter functions
        const addNewItem = async () => {
            const name = document.getElementById("setItemName").value;
            const price = document.getElementById("setItemPrice").value;
            const detail = document.getElementById("setItemDetails").value;
            const description = document.getElementById("setItemDescription").value;
        
            await window.contract.methods.add_item(price, name, detail, description).send({ from: account });
        }
        
        /* 
                
        <button onclick="setItemName()">SET ITEM NAME</button> <br>
        <input type="text" id="setItemName" placeholder="Enter Your Item's name"> <br>

        <button onclick="setItemPriceInETH()">SET ITEM PRICE (in ETH)</button> <br>
        <input type="text" id="setItemPrice" placeholder="Enter Your Item's price in ETH"> <br>

        <button onclick="setItemDetails()">SET ITEM DETAILS</button> <br>
        <input type="text" id="setItemDetails" placeholder="Enter Your Item's detail"> <br>

        <button onclick="setItemDescription()">SET ITEM DESCRIPTION</button> <br>
        <input type="text" id="setItemDescription" placeholder="Enter a brief description of your item"> <br>
        
        */

        //read data from smart contract
        const getItemName = async () => {
            const data = await window.contract.methods.getItemName().call();
            document.getElementById("dataArea1").innerHTML = data;
        }

        const getItemPriceInWei = async () => {
            const data = await window.contract.methods.getItemPriceInWEI().call();
            document.getElementById("dataArea10").innerHTML = data;
        }

        const getItemDetails = async () => {
            const data = await window.contract.methods.getItemDetails().call();
            document.getElementById("dataArea11").innerHTML = data;
        }

        const getItemDescription = async () => {
            const data = await window.contract.methods.getItemDescription().call();
            document.getElementById("dataArea12").innerHTML = data;
        }

        const getContractAccount= async () => {
            const data = await window.contract.methods.getAddress().call();
            document.getElementById("contractAccount").innerHTML = `Contract Account: ${data}`;
        }
        
        const getBalance= async () => {
            const data = await window.contract.methods.getBalance().call();
            document.getElementById("balanceArea").innerHTML = `Contract Balance (Wei): ${data}`;
        }


        const confirmShipped = async () => {
            try {
                const address_ = document.getElementById("addressInputCS").value;
                await window.contract.methods.confirmShipped(address_).send({ from: account });
                console.log("Shipping confirmed successfully!");
                document.getElementById("dataArea6").innerHTML = "Shipping confirmed successfully!";
            } catch (error) {
                console.error(error);
                document.getElementById("dataArea6").innerHTML = "Error confirming shipping: " + error;
            }
        };

        const refundSeller = async () => {
            try {
                const address_ = document.getElementById("addressInputRS").value;
                await window.contract.methods.refundSeller(address_).send({ from: account });
                console.log("Seller Refunded successfully!");
                document.getElementById("dataArea8").innerHTML = "Seller Refunded successfully!";
            } catch (error) {
                console.error(error);
                document.getElementById("dataArea8").innerHTML = "Error Refunding Seller: " + error;
            }
        };


        const addEscrow = async () => {

            console.log('hi');


            let result;
            await window.contract.methods.getValue().call()
              .then(function(value) {
                result = value;
              });
            console.log('hi');

            await window.contract.methods.addEscrow().send( {from: account, value: 20 * result} );
            console.log("Escrow added successfully!");
            document.getElementById("dataArea13").innerHTML = "Escrow added successfully!";
        }

        const closeContract = async () => {
            await window.contract.methods.closeContract().send({from: account});
            console.log("Contract closed successfully!");
            document.getElementById("dataArea14").innerHTML = "Contract closed successfully!";
        }


        //5-read data from smart contract
        const getBuyerState = async () => {
            const address = document.getElementById("addressBuyerState").value;
            var data = await window.contract.methods.getBuyerState(address).call();
            document.getElementById("dataArea3").innerHTML = `Buyer State: ${data}`;
        }

        //6-read data from smart contract
        const getBuyerNumber = async () => {
            const data = await window.contract.methods.getBuyerNumber().call();
            document.getElementById("dataArea4").innerHTML = `Current buyer number is ${data}`;
        }

    </script>

</body>
</html>